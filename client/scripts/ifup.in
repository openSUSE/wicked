#!/bin/bash
#
# Wicked ifup network interface configuration compatibility script.
#
# Copyright (c) 2013 SUSE LINUX Products GmbH, Nuernberg, Germany.
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation; either version 2 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Authors: Marius Tomaschewski <mt@suse.de>
#          Pawel Wieczorkiewicz <pwieczorkiewicz@suse.de>
#
###

unset POSIXLY_CORRECT ; set +o posix # we are using non-posix bash features
export PATH=/sbin:/usr/sbin:/bin:/usr/bin
if test -f /etc/sysconfig/network/config ; then
	.  /etc/sysconfig/network/config
fi

#
# Exit codes (from sysconfig's functions.commmon):
#
R_SUCCESS=0		# interface has been set up
R_ERROR=1		# any unspecified error
R_USAGE=2		# wrong usage
R_NOTIMPL=3		# feature not implemented
R_NOTALLOWED=4		# insufficient privilege

R_NODEV=7		# the given interface does not exist
R_NOTCONFIGURED=5	# the bootmode does not match the current mode
R_INACTIVE=5		# the interface is not up and it should not
R_NOTRUNNING=7		# the interface is not up but it should be up

R_NOCONFIG=9		# we could not find a matching configuration file
R_BUSY=10		# the interface is busy and should not be shut down.
			# It will be used for 'ifstatus ... -o stop' or ifdown ... -o
			# check' or whatever we use for the check if a interface can
			# be shut down savely.
R_LOCKED=11		# ifup/down is currently running on this interface
R_DHCP_BG=12		# dhcp client is running in bg, but no address up to now
			# or setting up firewall is still in progress
R_INTERNAL=$R_ERROR	# internal error, e.g. no config or missing scripts
R_NOT_UP2DATE=13	# returned from ifprobe if configuration has changed
R_PROPERTY_NOT_SET=14	# some property of the iface could not be set.
R_NO_IFPLUGD=15	# ifplugd is not running despite configured

#
# Helper functions
#
usage ()
{
	echo "Usage: if{up,down,status,probe} [<config>] <interface> [-o <options>]"
	echo ""
	echo "Common options are:"
	echo "    debug    : be verbose"
	echo ""
	echo "Options for if{up,down} are:"
	echo "    systemd  : Enables behavior required when called by wicked.service"
	echo ""
	echo "Options for if{status,probe} are:"
	echo "    quiet    : Do not print out errors, but just signal the result through exit status"
	echo ""
	echo "Unknown options are simply ignored, so be careful."
	echo ""
	exit $R_USAGE
}

mesg()
{
	local p s t

	case $1 in
	-p) shift; p="$1" ; shift ;;
	esac
	test $PPID -eq 1 || s="-s"
	test "X$SCRIPTNAME" = "X" || t="$SCRIPTNAME[$$]"

	printf -- "%s\n" "$*" | logger ${p:+-p $p} ${s:+-s} ${t:+-t "$t"}
}

debug()
{
	test "$DEBUG" = "yes" && mesg -p debug "$*"
}

systemd_running()
{
	mountpoint -q /sys/fs/cgroup/systemd
}

systemd_get_service_id()
{
	local service="$1"
	local _id=`systemctl --no-pager -p Id show "$service" 2>/dev/null`
	echo "${_id#Id=}"
}

systemd_get_network_service_id()
{
	systemd_get_service_id network.service
}


######################################################################
# Check responsibility
#
if systemd_running ; then
	network_service_id=`systemd_get_network_service_id`
	if test "X$network_service_id" != "Xwicked.service" ; then
		mesg "Network is managed by '$network_service_id' -> skipping"
		exit $R_USAGE
	fi
elif test "X$NETWORKMANAGER" = "Xyes" ; then
	mesg "Network is managed by NetworkManager -> skipping"
	exit $R_USAGE
fi


######################################################################
# Commandline parsing
#
SCRIPTNAME="${0##*/}"
case $SCRIPTNAME in
	ifup|ifstatus|ifdown|ifprobe)				;;
	*)		usage					;;
esac

INTERFACE=""
case $1 in
	""|-*)		usage					;;
	*)		INTERFACE=$1 ; shift			;;
esac
CONFIG=""
case $1 in
	""|-o)		shift					;;
	-*)		usage					;;
	*)		CONFIG="$INTERFACE" ; # unused
			INTERFACE="$1" ; shift			;;
esac
case $1 in
	-o)		shift					;;
esac
OPTIONS=$@
opt_debug=""
opt_systemd=""
opt_quiet=""
while [ $# -gt 0 ]; do
	case $1 in
	debug)		DEBUG="yes" ; opt_debug="most"		;;
	debug=*)	DEBUG="yes" ; opt_debug="${1#debug=}"	;;
	systemd)	opt_systemd="--systemd"			;;
	quiet)		opt_quiet="--quiet"			;;
	*)		debug "unknown option \"$1\""		;;
	esac
	shift
done

wicked_client="@wicked_sbindir@/wicked"
case $SCRIPTNAME in
	ifup)
		$wicked_client \
			${opt_debug:+--debug $opt_debug} \
			${opt_systemd} \
			ifup "$INTERFACE"
	;;
	ifdown)
		$wicked_client \
			${opt_debug:+--debug $opt_debug} \
			${opt_systemd} \
			ifdown "$INTERFACE"
	;;
	ifstatus)
		if test -z ${opt_quiet} ; then
			echo "Interface(s) state:"
		fi
		$wicked_client \
			${opt_debug:+--debug $opt_debug} \
			${opt_systemd} \
			ifcheck \
			  --state none \
			  ${opt_quiet} \
			  "$INTERFACE"
		if test -z ${opt_quiet} ; then
			echo ""
			echo "Interfaces(s) persistent mode:"
		fi
		$wicked_client \
			${opt_debug:+--debug $opt_debug} \
			${opt_systemd} \
			ifcheck \
			  --persistent \
			  ${opt_quiet} \
			  "$INTERFACE"
	;;
	ifprobe)
		$wicked_client \
			${opt_debug:+--debug $opt_debug} \
			${opt_systemd} \
			ifcheck \
			  --changed \
			  ${opt_quiet} \
			  "$INTERFACE"
	;;
esac

